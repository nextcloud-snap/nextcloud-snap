#!/bin/sh

# shellcheck source=src/common/utilities/common-utilities
. "$SNAP/utilities/common-utilities"

export NEXTCLOUD_CONFIG_DIR="$SNAP_DATA/nextcloud/config"
export NEXTCLOUD_DATA_DIR="$SNAP_COMMON/nextcloud/data"
DEFAULT_CRONJOB_INTERVAL="15m"

nextcloud_is_configured()
{
	[ -d "$NEXTCLOUD_CONFIG_DIR" ]
}

wait_for_nextcloud_to_be_configured()
{
	wait_for_command "Waiting for Nextcloud to be configured" nextcloud_is_configured
}

# Nextcloud doesn't consider itself "installed" until the admin account has been created
nextcloud_is_installed()
{
	# Urgh, occ still prints text warnings even with JSON output. Thus fromjson?.
	installed="$(occ status --output=json | jq -R 'fromjson? | .installed')"
	[ "$installed" = "true" ]
}

wait_for_nextcloud_to_be_installed()
{
	wait_for_command "Waiting for Nextcloud to be installed" nextcloud_is_installed
}

cronjob_interval()
{
	interval="$(snapctl get nextcloud.cron-interval)"
	if [ -z "$interval" ]; then
		interval="$DEFAULT_CRONJOB_INTERVAL"
		set_cronjob_interval "$interval"
		set_previous_cronjob_interval "$interval"
	fi

	echo "$interval"
}

previous_cronjob_interval()
{
	snapctl get private.nextcloud.cron-interval
}

set_cronjob_interval()
{
	snapctl set nextcloud.cron-interval="$1"
}

set_previous_cronjob_interval()
{
	snapctl set private.nextcloud.cron-interval="$1"
}
