#!/bin/sh

set -e
set -x

PRODUCT=nextant
NEXTCLOUD_APPS_FOLDER=$SNAP_DATA/nextcloud/extra-apps

# Config default values
SOLR_TIMEOUT=30
SOLR_URL="http://127.0.0.1:8983/solr/"
SOLR_CORE="nextant"

CONFIGURED=2
INDEX_FILES_NEEDED=1
INDEX_LIVE=2

while [ ! -e $NEXTCLOUD_APPS_FOLDER ]; do
	sleep 10
done

[ -e $NEXTCLOUD_APPS_FOLDER/$PRODUCT ] 	|| cp -rf $SNAP/$PRODUCT $NEXTCLOUD_APPS_FOLDER

# enable nextant app. Retry until having nextcloud configured
while ! $SNAP/bin/occ app:enable $PRODUCT; do
		# wait for 30 seconds before retrying
        sleep 30
done

# configure with default parameters
$SNAP/bin/occ config:app:set $PRODUCT configured --value="$CONFIGURED"
$SNAP/bin/occ config:app:set $PRODUCT index_files_needed --value="$INDEX_FILES_NEEDED"
$SNAP/bin/occ config:app:set $PRODUCT index_live --value="$INDEX_LIVE"

$SNAP/bin/occ config:app:set $PRODUCT solr_timeout --value="$SOLR_TIMEOUT"
$SNAP/bin/occ config:app:set $PRODUCT sorl_url --value="$SOLR_URL"
$SNAP/bin/occ config:app:set $PRODUCT solr_core --value="$SOLR_CORE"

# kind of workaround to avoid using UI
$SNAP/bin/occ $PRODUCT:check --fix

# index
$SNAP/bin/occ $PRODUCT:index

## Configure autocompletion for search. First step is modifying solr config
NEXTANT_SOLR_CONFIG_FILE=$NEXTCLOUD_APPS_FOLDER/$PRODUCT/config/nextant_solrconfig.xml
SOLR_CONFIG_FILE=$SNAP_COMMON/solr/$PRODUCT/conf/solrconfig.xml
sed -i "/<?xml version=\"1.0\" encoding=\"UTF-8\" ?>/a <!DOCTYPE config [\n\t<!ENTITY nextant_component SYSTEM \"$NEXTANT_SOLR_CONFIG_FILE\">\n\t]>" $SOLR_CONFIG_FILE
sed -i "/<\/config>/i &nextant_component;" $SOLR_CONFIG_FILE

$SNAP/bin/solr-server restart
